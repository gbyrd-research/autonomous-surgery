Bootstrap: docker
From: nvidia/cuda:12.1.1-devel-ubuntu22.04

%labels
    Author Grayson Byrd
    CUDA 12.1
    PyTorch 2.4.0
    Python 3.11

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PATH=/opt/conda/bin:$PATH

%post
    set -e

    echo "Installing system dependencies..."
    apt-get update && apt-get install -y \
        python3.11 \
        python3.11-dev \
        python3.11-distutils \
        curl \
        wget \
        git \
        build-essential \
        cmake \
        ninja-build \
        bzip2 \
        ca-certificates \
        libgl1-mesa-dev \
        libglib2.0-0 \
        && rm -rf /var/lib/apt/lists/*

    echo "Installing Node.js (LTS) and npm..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs

    node --version
    npm --version

    npm install -g @openai/codex

    echo "Installing Miniconda..."
    wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \
        -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/conda
    rm /tmp/miniconda.sh

    /opt/conda/bin/conda clean -afy

    echo "Installing pip for system Python 3.11..."
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11

    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1

    python -m pip install --upgrade pip setuptools wheel

    echo "Installing PyTorch + torchvision (CUDA 12.1)..."
    python -m pip install \
        torch==2.4.0 \
        torchvision==0.19.0 \
        --extra-index-url https://download.pytorch.org/whl/cu121

    mkdir -p /tmp/wheels
    cp /pytorch3d_wheels/*.whl /tmp/wheels/
    python -m pip install /tmp/wheels/*.whl
    rm -rf /tmp/wheels

%files
    wheelhouse/pytorch3d-*.whl  /pytorch3d_wheels/

%runscript
    exec "$@"

